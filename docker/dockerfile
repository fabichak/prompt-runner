# ComfyUI Base Image with CUDA 12.8 and Python 3.12
# Using vastai/pytorch as base which includes CUDA support

FROM vastai/pytorch:cuda-12.8.1-auto

# Set working directory
WORKDIR /workspace

# Install system dependencies in one layer to reduce size
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    software-properties-common \
    && add-apt-repository ppa:deadsnakes/ppa \
    && apt-get update && apt-get install -y --no-install-recommends \
    python3.12 \
    python3.12-dev \
    python3.12-venv \
    wget \
    curl \
    git \
    unzip \
    zip \
    dos2unix \
    htop \
    tmux \
    nano \
    vim \
    ffmpeg \
    libgl1 \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    libopencv-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Make python3.12 the default python
RUN update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1 \
    && update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1

# Upgrade pip and install core packages in one layer
RUN pip install --no-cache-dir \
    gdown \
    requests \
    tqdm \
    numpy \
    scipy \
    matplotlib \
    opencv-python \
    Pillow \
    imageio \
    imageio-ffmpeg \
    ffmpeg-python \
    pyyaml \
    jsonschema

# Install PyTorch with CUDA 12.4 support (compatible with CUDA 12.8 driver)
# Using cu124 as cu128 doesn't exist yet
RUN pip install --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128

# Install triton separately
RUN pip install --no-cache-dir triton

# Install ML/AI packages
RUN pip install --no-cache-dir \
    sageattention \
    transformers \
    diffusers \
    accelerate \
    safetensors \
    omegaconf \
    einops \
    torchsde

# Install ComfyUI common dependencies
RUN pip install --no-cache-dir \
    aiohttp \
    aiofiles \
    pydantic \
    python-multipart \
    websocket-client \
    psutil \
    typer \
    rich \
    gitpython

# Install Google Cloud SDK
RUN curl -O https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-cli-linux-x86_64.tar.gz && \
    tar -xf google-cloud-cli-linux-x86_64.tar.gz && \
    ./google-cloud-sdk/install.sh --quiet --path-update true && \
    rm google-cloud-cli-linux-x86_64.tar.gz

# Add gcloud to PATH permanently
ENV PATH="/workspace/google-cloud-sdk/bin:${PATH}"

# Set CUDA environment variables
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=${CUDA_HOME}/bin:${PATH}
ENV LD_LIBRARY_PATH=${CUDA_HOME}/lib64:${LD_LIBRARY_PATH}
ENV TORCH_CUDA_ARCH_LIST="7.0;7.5;8.0;8.6;8.9;9.0"

# Verify installations
RUN python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA Available: {torch.cuda.is_available()}'); print(f'CUDA Version: {torch.version.cuda}')"

# Label the image
LABEL maintainer="xxtria@gmail.com"
LABEL description="ComfyUI base image with Python 3.12, PyTorch 2.5.1, and CUDA 12.4/12.8 support"
LABEL version="3.0"

# Default command
CMD ["/bin/bash"]